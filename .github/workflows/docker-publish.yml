name: Docker Publish

# åªæž„å»ºå¹¶æŽ¨é€ Docker é•œåƒï¼Œä¸åˆ›å»º Release æˆ– Tag
on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'é•œåƒæ ‡ç­¾ (ä¾‹å¦‚: latest, dev, v3.0.0)'
        required: true
        default: 'latest'
        type: string
      build_frontend:
        description: 'æž„å»ºå‰ç«¯é•œåƒ'
        required: false
        type: boolean
        default: true
      build_backend:
        description: 'æž„å»ºåŽç«¯é•œåƒ'
        required: false
        type: boolean
        default: true
      build_sandbox:
        description: 'æž„å»ºæ²™ç®±é•œåƒ'
        required: false
        type: boolean
        default: true

jobs:
  build-and-push:
    name: æž„å»ºå¹¶æŽ¨é€é•œåƒ
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è½¬æ¢ç”¨æˆ·åä¸ºå°å†™
        id: lowercase
        run: echo "owner=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: ç™»å½•åˆ° GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® QEMU
        uses: docker/setup-qemu-action@v3

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: æž„å»ºå¹¶æŽ¨é€å‰ç«¯ Docker é•œåƒ
        if: ${{ github.event.inputs.build_frontend == 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          no-cache: true  # ðŸ”¥ å¼ºåˆ¶ç¦ç”¨ç¼“å­˜ï¼Œç¡®ä¿ä½¿ç”¨æœ€æ–°ä»£ç 
          platforms: linux/amd64,linux/arm64
          build-args: |
            VITE_API_BASE_URL=/deepaudit/api/v1
          tags: |
            ghcr.io/${{ steps.lowercase.outputs.owner }}/deepaudit-frontend:${{ github.event.inputs.tag }}
          cache-from: type=gha,scope=frontend
          cache-to: type=gha,mode=max,scope=frontend

      - name: æž„å»ºå¹¶æŽ¨é€åŽç«¯ Docker é•œåƒ
        if: ${{ github.event.inputs.build_backend == 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/${{ steps.lowercase.outputs.owner }}/deepaudit-backend:${{ github.event.inputs.tag }}
          cache-from: type=gha,scope=backend
          cache-to: type=gha,mode=max,scope=backend

      - name: æž„å»ºå¹¶æŽ¨é€æ²™ç®± Docker é•œåƒ
        if: ${{ github.event.inputs.build_sandbox == 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: ./docker/sandbox
          file: ./docker/sandbox/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/${{ steps.lowercase.outputs.owner }}/deepaudit-sandbox:${{ github.event.inputs.tag }}
          cache-from: type=gha,scope=sandbox
          cache-to: type=gha,mode=max,scope=sandbox

      - name: è¾“å‡ºé•œåƒä¿¡æ¯
        run: |
          echo "## é•œåƒå·²æŽ¨é€åˆ° GHCR" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.build_frontend }}" == "true" ]; then
            echo "- \`ghcr.io/${{ steps.lowercase.outputs.owner }}/deepaudit-frontend:${{ github.event.inputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ github.event.inputs.build_backend }}" == "true" ]; then
            echo "- \`ghcr.io/${{ steps.lowercase.outputs.owner }}/deepaudit-backend:${{ github.event.inputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ github.event.inputs.build_sandbox }}" == "true" ]; then
            echo "- \`ghcr.io/${{ steps.lowercase.outputs.owner }}/deepaudit-sandbox:${{ github.event.inputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          fi
